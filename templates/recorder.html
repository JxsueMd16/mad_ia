<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Asistente de Voz IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
      .container { max-width: 600px; }
      .btn-record { border: none; background: transparent; transition: transform 0.2s; }
      .btn-record:hover { transform: scale(1.05); }
      .btn-record-green { filter: hue-rotate(80deg); }
      .btn-record-red { filter: hue-rotate(0deg); animation: pulse 1.5s infinite; }
      .mic-img { width: 96px; height: 96px; cursor: pointer; }
      .record-spinner { vertical-align: middle; }
      .text-box { 
        background: rgba(255,255,255,0.95); 
        border-radius: 12px; 
        padding: 20px; 
        min-height: 100px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .robot-status { 
        color: white; 
        font-size: 0.9rem; 
        margin-top: 10px;
        opacity: 0.9;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="h3 text-center text-white mb-4">ü§ñ Asistente Robot</h1>

      <div class="row mt-3 px-3">
        <div class="col-12 text-center">
          <!-- Bot√≥n grabar -->
          <button type="button" class="btn-record btn-record-green" id="record" onclick="record()">
            <img class="mic-img" src="/static/img/microphone.png" alt="grabar" />
          </button>
          
          <!-- Bot√≥n detener -->
          <button type="button" class="btn-record btn-record-red" id="stop" onclick="stopRec()" style="display:none">
            <img class="mic-img" id="record-stop-label" src="/static/img/microphone.png" alt="detener" />
            <span id="record-stop-loading" style="display: none">
              <span class="spinner-border spinner-border-sm record-spinner text-light" role="status"></span>
            </span>
          </button>
          
          <div class="robot-status" id="status">Presiona el micr√≥fono para hablar</div>
        </div>
        
        <div class="col-12 text-center mt-4">
          <div id="text" class="text-box">Esperando comando...</div>
        </div>
      </div>
    </div>

<script>
  let blobs = [];
  let stream;
  let rec;
  let recordStartTime;

  function updateStatus(msg) {
    document.getElementById("status").textContent = msg;
  }

  async function record() {
    try {
      updateStatus("üî¥ Grabando... Habla ahora");
      document.getElementById("text").innerHTML = "<i style='color: #667eea;'>Escuchando...</i>";
      document.getElementById("record").style.display = "none";
      document.getElementById("stop").style.display = "";
      document.getElementById("record-stop-label").style.display = "block";
      document.getElementById("record-stop-loading").style.display = "none";
      document.getElementById("stop").disabled = false;

      blobs = [];
      recordStartTime = Date.now();

      // Configuraci√≥n de audio optimizada
      const constraints = { 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }, 
        video: false 
      };
      
      stream = await navigator.mediaDevices.getUserMedia(constraints);

      const options = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
        ? { mimeType: "audio/webm;codecs=opus" }
        : {};

      rec = new MediaRecorder(stream, options);
      rec.ondataavailable = e => { if (e.data && e.data.size > 0) blobs.push(e.data); };
      rec.onstop = doUpload;
      rec.start();
    } catch (e) {
      alert("Error de micr√≥fono. Permite acceso y usa http://127.0.0.1:5000");
      updateStatus("Error: No se pudo acceder al micr√≥fono");
      console.error(e);
    }
  }

  function stopRec() {
    const recordDuration = Date.now() - recordStartTime;
    
    // Validar duraci√≥n m√≠nima (300ms)
    if (recordDuration < 300) {
      alert("Grabaci√≥n muy corta. Habla al menos medio segundo.");
      resetUI();
      return;
    }

    updateStatus("‚è≥ Procesando audio...");
    document.getElementById("record-stop-label").style.display = "none";
    document.getElementById("record-stop-loading").style.display = "block";
    document.getElementById("stop").disabled = true;

    if (rec && rec.state !== "inactive") rec.stop();
    if (stream) stream.getTracks().forEach(t => t.stop());
  }

  function resetUI() {
    document.getElementById("record").style.display = "";
    document.getElementById("stop").style.display = "none";
    updateStatus("Presiona el micr√≥fono para hablar");
  }

  function doUpload() {
    if (!blobs.length) {
      document.getElementById("text").innerHTML = "<span style='color: red;'>No se captur√≥ audio</span>";
      resetUI();
      return;
    }

    const blob = new Blob(blobs);
    const fd = new FormData();
    fd.append("audio", blob, "grabacion.webm");

    fetch("/audio", { method: "POST", body: fd })
      .then(async (response) => {
        const ct = response.headers.get("content-type") || "";
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status} - ${text.substring(0, 200)}`);
        }
        if (!ct.includes("application/json")) {
          const text = await response.text();
          throw new Error(`Respuesta no-JSON: ${text.substring(0, 200)}`);
        }
        return response.json();
      })
      .then(res => {
        resetUI();
        
        if (!res || res.result === "error") {
          document.getElementById("text").innerHTML = `<span style='color: red;'>${res?.text || "Error procesando audio"}</span>`;
          updateStatus("Error en el procesamiento");
          return;
        }
        
        const responseText = res.text || "(Sin respuesta)";
        document.getElementById("text").textContent = responseText;
        updateStatus("‚úÖ Respuesta lista");
        
        if (res.file) {
          const audio = new Audio(`/static/${res.file}?nocache=${Date.now()}`);
          audio.play().catch(e => console.log("Error reproduciendo:", e));
        }
      })
      .catch(err => {
        console.error("Error:", err);
        document.getElementById("text").innerHTML = "<span style='color: red;'>Error de conexi√≥n. Revisa la consola.</span>";
        updateStatus("‚ùå Error de servidor");
        resetUI();
      });
  }
</script>

  </body>
</html>